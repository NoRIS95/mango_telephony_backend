# Бэкэнд-сервер для сайта MANGO OFFICE.
В этом бэкэнд-сервере присутствуют эндпонты __/send_sms__, __/callback__,  __/group_callback__, __/end_call__, __/start_record__, __/start_play__, __/route_call__, __/transfer_call__, __/get_stats_to__, __/get_stats_from__, __/get_stats_call_party__, __/get_dct_user_info__, __/get_dct_user_history__, __/user_list__, __/group_list__, __/balance__, __/lines__, __/audio__, __/set_schema__, __/get_ext_field__, __/roles__, __/sips_list__, __/domains_list__, __/trunk_num_list__, __/bwlist_state__, __/bwlist_nums__, __/add_bwlist__, __/delete_bwlist__, __/campaign_info__, __/ab_contact_init__, __/cc_deal_list__, и __/cc_deal_funnels_list__, с помощью которых  можно отправлять СМС,  совершать обратный звонок номеру потенциального клиента от внутреннего номера, совершать групповой обратный звонок, завершенить вызов, начать запись разговора относительно сотрудника, проигрывать нужную запись в IVR, выполнить маршрутизацию вызова (пока он IVR), выполнить перевод вызова,получить статистику входящих для указанного абонента,получить статистику исходящих для указанного абонента,получить метки ДКТ,получить историю переходов пользователя,получить список сотрудников,получить список групп,узнать баланс,получить исходящие линии,получить список мелодий ожидания,установить схему на номер,получить список схем,получить список ролей,получить список sip-учеток,получить список доменов,получить список номеров из транков, узнать статус ЧБ списка,получить список номеров в ЧБ списке, добавить номер в ЧБ список, удалить номер из ЧБ списка, получить информацию о кампании ИО, инициировать получение списка контактов, запросить список сделок и запросить стадии воронки.
### Инструкция по запуску бэкенд-сервера:
  1.Клонируем репозиторий с сайта GitHub и заходим в директорию с проектом:
  ```
  git clone git@github.com:NoRIS95/mango_telephony_backend.git
  cd mango_telephony_backend

  ```
  2.Создаём виртуальное окружение (в нашем случае оно будет называться env) и активируем его:
  ```
  python3 -m venv env
  source ./env/bin/activate
  ```
  3. Устанавливаем зависимости из текстового файла requirements.txt
  ```
  pip install -r requirements.txt
  ```
  4. Запускаем наш сервер:
  ```
  python main.py
  ```
## REST API
### Categories API
#### Отправка SMS
```POST /send_sms```
Параметры:
* number - номер вызываемого абонента
* text - текст сообщения
* from_ext - идентификатор сотрудника
* command_id - идентификатор команды
* sender - имя отправителя SMS-сообщения

#### Обратный звонок абоненту от внутреннего номера
``` POST /callback```
Параметры:
* from_ext - идентификатор сотрудника
* to_num - номер вызываемого абонента
* command_id - идентификатор команды
* from_num - номер вызывающего абонента
* line - линия, которая была использована для размещения вызова
* sip_head - опциональное поле, которое содержит список заголовков SIP, которые могут быть переданы внешней системой в ВАТС


#### Групповой обратный звонок
``` POST /group_callback```
Параметры:
* from_ext - идентификатор сотрудника
* to_num - номер вызываемого абонента
* command_id - идентификатор команды
* line - линия, которая была использована для размещения вызова


#### # Завершения вызова
``` POST /end_call```
Параметры:
* call_id - внутренний идентификатор вызова
* command_id - идентификатор команды


#### Начало записи разговора относительно сотрудника
``` POST /start_record```
Параметры:
* call_id - внутренний идентификатор вызова
* call_party_number - номер абонента, участвующего в вызове, которого нужно начать записывать
* command_id - идентификатор команды

#### Проигрывания нужной записи в IVR
``` POST /start_play```
Параметры:
* call_id - внутренний идентификатор вызова
* internal_id - число, опционально
* command_id - идентификатор команды
* after_play_time - ID аудиофайла в облачном хранище из продукта клиента

#### Маршрутизация вызова (пока он IVR)
``` POST /route_call```
Параметры:
* call_id - внутренний идентификатор вызова, маршрут которого необходимо изменить.
* to_number - новый номер назначения вызова. Может быть идентификатором сотрудника ВАТС, внутренним номером группы операторов ВАТС или любым другим номером.
* command_id - идентификатор команды
* sip_headers - опциональное поле, которое содержит список заголовков SIP, которые могут быть переданы внешней системой в ВАТС

#### Перевод вызова
``` POST /transfer_call```
Параметры:
* call_id - внутренний идентификатор вызова, для которого
выполняется перевод
* to_number - цель перевода, номер вызываемого абонента (строка не более 128 байт). Может быть идентификатором сотрудника ВАТС, внутренним номером группы операторов ВАТС или любым другим номером.
* method - строка, принимающая следующие возможные значения: "blind" – слепой перевод; "hold" – консультативный перевод
* initiator - участник разговора, от имени которого выполняется перевод
* command_id - идентификатор команды

#### Получение статистики входящих для указанного абонента
``` POST /get_stats_to```
Параметры:
* to_ext - идентификатор сотрудника ВАТС для
вызываемого абонента.
* date_from - предоставить статистику с указанного времени.
Формат данных — timestamp (unix время, часовой
пояс utc+3), даёт возможность указать время с
точностью до одной секунды.
* date_to - предоставить статистику по указанное время.
* fields - позволяет указать какие поля (см. список
возможных полей ниже) и в каком порядке
необходимо включить в выгрузку. Значение по
умолчанию:
	+ records,
	+ start,
	+ finish,
	+ answer,
	+ from_extension,
	+ from_number, 
	+ to_extension,
	+ to_number,
	+ disconnect_reason
	+ line_number, 
	+ location.
* to_num - номер вызываемого абонента (строка) (для PSTN номеров в формате E164).
* request_id - идентификатор запроса (строка не более 128 байт), опциональное поле. Формируется внешней системой

#### Получение статистики исходящих для указанного абонента
``` POST /get_stats_from```
Параметры:
* from_ext - идентификатор сотрудника ВАТС для
вызывающего абонента
* date_from - предоставить статистику с указанного времени.
Формат данных — timestamp (unix время, часовой
пояс utc+3), даёт возможность указать время с
точностью до одной секунды.
* date_to - предоставить статистику по указанное время.
* fields - позволяет указать какие поля (см. список
возможных полей ниже) и в каком порядке
необходимо включить в выгрузку. Значение по
умолчанию:
	+ records,
	+ start,
	+ finish,
	+ answer,
	+ from_extension,
	+ from_number, 
	+ to_extension,
	+ to_number,
	+ disconnect_reason
	+ line_number, 
	+ location.
* from_num - номер вызывающего абонента (строка) (для PSTN номеров в формате E164)
* request_id - идентификатор запроса (строка не более 128 байт), опциональное поле. Формируется внешней системой

#### Получение статистики всех вызовов для указанного абонента
``` POST /get_stats_call_party```
Параметры:
* call_party_ext - идентификатор сотрудника ВАТС
* date_from - предоставить статистику с указанного времени.
Формат данных — timestamp (unix время, часовой
пояс utc+3), даёт возможность указать время с
точностью до одной секунды.
* date_to - предоставить статистику по указанное время.
* fields - позволяет указать какие поля (см. список
возможных полей ниже) и в каком порядке
необходимо включить в выгрузку. Значение по
умолчанию:
	+ records,
	+ start,
	+ finish,
	+ answer,
	+ from_extension,
	+ from_number, 
	+ to_extension,
	+ to_number,
	+ disconnect_reason
	+ line_number, 
	+ location.
* call_party_num - Номер абонента (строка) (для PSTN номеров в формате E164)
* request_id - идентификатор запроса (строка не более 128 байт), опциональное поле. Формируется внешней системой

#### Получение меток ДКТ
``` POST /get_dct_user_info```
Параметры:
* number -  динамический номер

#### Получение истории переходов пользователя
``` POST /get_dct_user_history```
Параметры:
* number -  динамический номер

#### Получение списка сотрудников
``` POST /user_list```
Параметры:
* ext_fields - если указано, то возвращается информация о данной группе
* extension - идентификатор сотрудника ВАТС, настройки которого запрашиваются, опциональный параметр. Для получения полного списка сотрудников параметр не передается

#### Получение списка групп
``` POST /group_list```
Параметры:
* group_id - если указано, то возвращается информация о данной группе
* operator_id - id сотрудника (необязательный). Если указан, то возвращается только список групп, куда включен сотрудник. Иначе - возвращаются все группы.
* operator_extension - внутренний номер сотрудника (необязательный). Если указан, то возвращается только список групп, куда включен сотрудник. Иначе - возвращаются все группы
* show_users - Признак, выводить ли в ответет сотрудников в группах/группе (необязательный). Если указан (0 - нет / 1 - да), то в ответе возвращается вместе со списком сотрудников. Иначе - только список групп

#### Получение баланса
``` POST /balance```
Параметры:
* отсутствуют

#### Получение исходящих линий
``` POST /lines```
Параметры:
* отсутствуют

#### Получение списка мелодий ожидания
``` POST /audio```
Параметры:
* отсутствуют

#### Установка схемы на номере
``` POST /set_schema```
Параметры:
* schema - id схемы
* line - id линии
* trunk - Тип данных, опционально, id номера sip-trunk'a исходящего номера (у номера поле options должно быть 2 или 6)

#### Получение списка схем
``` POST /get_ext_field```
Параметры:
* ext_fields - номер sip-trunk'а

#### Получение списка ролей
``` POST /roles```
Параметры:
* отсутствуют

#### Получение списка sip-учеток
``` POST /sips_list```
Параметры:
* отсутствуют

#### Получение списка доменов
``` POST /domains_list```
Параметры:
* отсутствуют

#### Получение списка номеров из транков
``` POST /trunk_num_list```
Параметры:
* отсутствуют

#### Получение статуса ЧБ списка
``` POST /bwlist_state```
Параметры:
* отсутствуют

#### Получение списка номеров в ЧБ списке
``` POST /bwlist_nums```
Параметры:
* отсутствуют

#### Добавление номера в ЧБ
``` POST /add_bwlist```
Параметры:
* number - номер
* list_type - тип списка
* num_type - тип номера, "tel", "sip".
* comment - комментарий, до 255 символов

#### Удаление номера из ЧБ списка
``` DELETE /delete_bwlist```
Параметры:
* num_id - id номера

#### Получение информации о кампании ИО
``` POST /campaign_info```
Параметры:
* campaign_id - ID кампании

#### Инициирование получения списка контактов
``` POST /ab_contact_init```
Параметры:
* query - обязательный, строка поиска, допустима передача пустой строки для возврата списка всех групп
* limit_rows -  кол-во выбираемых строк
* order - опционально, массив объектов вида [ { "field": "asc | desc" },... ], - правило сортировки; порядок следования объектов в массиве определяет порядок сортировки
* contact_ext_fields - признак необходимости возвращать значения пользовательских полей (custom_values) и поля идентификатор персонального сотрудника (user_id)

#### Запрос списка сделок
``` POST /cc_deal_list```
Параметры:
* product_id -  id продукта
* status -  доступен один из следующих статусов для отбора:
	+ "in_work" - в работе;
	+ "succeed" - состоялась;
	+ "failed" - не состоялась;
	+ "delete" - удалена
* from_date - дата начала периода
* until_date - дата окончания периода
* members_ids - признак необходимости возвращать значения пользовательских полей (custom_values) и поля идентификатор персонального сотрудника (user_id)
* contact_id - уникальный номер контакта. 

#### Запрос стадий воронки
``` POST /cc_deal_funnels_list```
Параметры:
* product_id -  id продукта
